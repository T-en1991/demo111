# Ocean Fish — 开发者指南

版本：1.0
日期：2025-11-10

本文档为中文开发者指南，涵盖项目启动、架构、关键实现与常见问题排查步骤。

目录
- 项目概述
- 前置环境
- 本地开发环境搭建
- 代码结构（关键文件）
- 启动与构建
- 数据库（Prisma + SQLite）
- 网络监听（TCP 解析）
- IPC 与 preload
- 测试与校验
- 打包与发布
- 常见问题与排查

项目概述
-------
Ocean Fish 是一个基于 Electron 与 Vue 的桌面应用，用于管理“机器鱼”设备并接收设备上报的告警/图片通知。主进程负责网络监听（TCP）、解析报文并将解析后的结构化告警写入本地 SQLite（通过 Prisma）。渲染进程提供管理界面（机器鱼列表、告警查看等）。

前置环境
------
- Node.js (建议 >=18)
- npm
- Git
- 可选：sqlite3 用于快速检查本地数据库

本地开发环境搭建
---------------
1. 安装依赖

```powershell
cd path\to\demo111
npm install
```

2. 配置 `.env`（若不存在）

```
DATABASE_URL="file:./src/main/prisma/dev.db"
```

3. 应用数据库变更并生成 Prisma Client（在修改 `schema.prisma` 后）

> 请先停止任何运行中的 dev/electron 进程，避免 Windows 文件锁（EPERM）问题。

```powershell
npm run db:push
npm run db:generate
```

4. 启动开发服务器

```powershell
npm run dev
```

代码结构（关键文件）
-----------------
- `src/main` — Electron 主进程代码
  - `index.ts` — 启动入口
  - `app.ts` — 应用初始化与生命周期管理
  - `database/index.ts` — Prisma 客户端封装与服务（fishService、alertService）
  - `network/tcpManager.ts` — per-fish TCP 监听与解析
  - `ipc/` — ipc handlers
- `src/preload` — preload 脚本及类型声明（`index.ts`, `index.d.ts`）
- `src/renderer` — Vue 前端代码（views、components、store）
- `src/main/prisma` — Prisma schema 与 migration

启动与构建
---------
- 开发：`npm run dev`
- 构建（含类型检查）：`npm run build`
- 打包：`npm run build:win|mac|linux`

数据库（Prisma + SQLite）
----------------------
- 模式文件：`src/main/prisma/schema.prisma`
- 本地 DB 文件：`src/main/prisma/dev.db`
- 常用命令：
  - `npm run db:push` — 将 schema 同步到数据库（无需完整迁移历史）
  - `npm run db:migrate` — 创建并运行迁移（推荐在需要版本控制迁移时）
  - `npm run db:generate` — 生成 Prisma Client

注意：在 Windows 上，Prisma 在生成本机查询引擎时会写入 `node_modules/.prisma/client`，如遇 EPERM，确保停止运行中的 Electron/Node 进程或重启机器。

网络监听（TCP 解析）
-----------------
- `src/main/network/tcpManager.ts` 为每个配置了 ip/port 的 Fish 创建独立的 `net.createServer`。
- on `socket.data` 的流程：
  1. 尝试解析为 JSON；
  2. 若非 JSON，尝试解析 `ID=...;C=...;IMG=...;POS=lat,lon` 格式（解析 deviceId, channel, filename, lat, lon），并发送 ACK；
  3. 或解析 `+++AT*SENDIM,...,ALARM-OK,<filename>` 格式（只解析 filename）；
  4. 将解析出的字段写入 `Alert` 表（imgFile、lat、lon、fishId 等）。

IPC 与 preload
--------------
- `src/preload/index.ts` 使用 `contextBridge.exposeInMainWorld('api', api)` 暴露 `window.api`，该对象提供 `fish` CRUD 等方法。
- 渲染进程的类型声明在 `src/renderer/src/env.d.ts` 中，确保与 `src/preload/index.d.ts` 保持一致。

测试与校验
---------
- 类型检查：`npm run typecheck`
- Lint：`npm run lint`
- 格式化：`npm run format`

打包与发布
---------
- 确保在构建/打包前运行 `prisma generate`。
- 若要随包发布一个预置的 SQLite 数据库：将 DB 文件放到 `extraResources`，在应用首次启动时将它复制到 `app.getPath('userData')`，然后把 `DATABASE_URL` 指向该位置。

常见问题与排查
-------------
- EPERM during `prisma generate`:
  - 停止 dev/electron 进程或重启机器；排除杀毒软件对 `node_modules` 的干扰；在管理员权限下重试。
- `window.api` 在 renderer 中被识别为 `unknown`：
  - 检查 `src/renderer/src/env.d.ts` 和 `src/preload/index.d.ts` 是否一致，重启 TS server / IDE。
- Schema 更改与迁移不一致：
  - 使用 `prisma migrate dev` 生成迁移或手动同步 `migration.sql`，并备份数据库以免数据丢失。

附录
---
我也可以为你生成：
- Prisma 模型 ER 图（文本或图片）
- 告警解析器的单元测试脚本
- 打包时自动复制预置 DB 的脚本示例

需要我现在生成哪一项？
