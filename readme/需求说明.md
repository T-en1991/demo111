# Ocean Fish — 需求说明书

版本：1.0
日期：2025-11-10

目的
----
本文档描述 Ocean Fish 桌面应用的功能性与非功能性需求。该应用基于 Electron + Vue + TypeScript，负责管理“机器鱼”（Fish）设备，监听设备通过 TCP 发送的告警/通知包，解析特定格式数据，返回 ACK（在需要时），并将解析后的结构化告警保存到本地 SQLite 数据库（使用 Prisma）。

利益相关者
--------
- 产品负责人 / 运营 — 需要可靠的本地告警收集和监控能力
- 开发人员 — 实现特性、打包和部署
- 现场设备 / 系统集成方 — 按约定格式发送告警报文到指定 IP/端口

术语表
------
- Fish（机器鱼）：被管理的设备实体，可选配置 IP 和 port 用于监听
- Alert（告警）：从设备或 Fish 收到的事件，保存到本地数据库
- SENDIM：设备使用的报文格式，例如 `+++AT*SENDIM,...,ALARM-OK,<filename>` 表示图片/告警通知

功能需求
--------
1. 机器鱼管理
   - R1.1: 支持机器鱼的 CRUD（名称、类型、IP、端口、状态）。
   - R1.2: 渲染进程（UI）提供查看与编辑机器鱼的界面。
   - R1.3: 每个机器鱼可选配置 IP 与端口；主进程会为配置了 IP+端口的机器鱼启动对应的 TCP 监听。

2. 网络监听与解析
   - R2.1: 对于每个配置了 ip+port 的机器鱼，主进程在指定 ip:port 上启动 TCP 服务。
   - R2.2: 服务接收连接并读取数据包。
   - R2.3: 首先尝试将数据解析为 JSON，若不是 JSON 则按已知文本格式解析。
   - R2.4: 支持的文本格式：
     - `ID=<device_id>;C=<channel_id>;IMG=<filename>;POS=<lat>,<lon>` — 解析 deviceId、channel、图片文件名、经纬度。
     - `+++AT*SENDIM,33,2,ack,ALARM-OK,<filename>` — 解析文件名。
   - R2.5: 对于 ID 格式的报文，向发送方回复 ACK：`+++AT*SENDIM,33,2,ack,ALARM-OK,<filename>\r\n`。
   - R2.6: 将解析后的告警以结构化字段存储到数据库（包含 fishId, imgFile, lat, lon 等）。

3. 数据持久化
   - R3.1: 使用 Prisma + SQLite。开发环境通过 `.env` 中的 DATABASE_URL 指向 `file:./src/main/prisma/dev.db`。
   - R3.2: 告警表包含 title、message、level、type、source、imgFile（可选）、lat（可选）、lon（可选）、fishId（可选）、createdAt、status 等字段。

4. IPC / 渲染进程接口
   - R4.1: preload 脚本通过 contextBridge 暴露安全的 `window.api`，提供 `fish` 的 CRUD 方法和 `quitApp()`。
   - R4.2: 渲染进程通过这些 API 管理机器鱼与读取告警。

5. 打包与部署
   - R5.1: 使用 electron-builder 打包为目标平台的安装包（Windows/macOS/Linux）。
   - R5.2: 在构建时生成 Prisma Client 并包含在包内。若发布带有预置 DB 的版本，应将 SQLite 文件放到 extraResources 并在应用首次启动时复制到 `app.getPath('userData')`。

非功能需求
--------
- N1: 可靠性 — 网络解析和 DB 写入不能让主进程崩溃。
- N2: 安全性 — 使用 contextIsolation，预加载层只暴露最小必需 API。
- N3: 性能 — 能够处理适度并发的设备上报；若解析/写入压力大，考虑使用 worker。
- N4: 可观测性 — 使用日志（winston）记录错误和关键事件。

约束
----
- C1: 数据库使用 SQLite（本地文件）和 Prisma。
- C2: 网络监听与 DB 逻辑运行在 Electron 主进程。
- C3: Windows 下生成 Prisma 二进制时可能发生文件锁（EPERM），在生成前需停止运行的进程。

数据模型（摘要）
--------------
- Fish
  - id: Int
  - name: String
  - type: String
  - ip: String?（可选）
  - port: Int?（可选）
  - status: FishStatus（running|stopped）
  - createdAt: DateTime

- Alert
  - id: Int
  - title: String
  - message: String?
  - level: AlertLevel（info|warning|error|critical）
  - type: String?
  - source: String?
  - imgFile: String?
  - lat: Float?
  - lon: Float?
  - fishId: Int?（可选，关联 Fish）
  - status: AlertStatus（active|resolved|acknowledged）
  - createdAt: DateTime

接口 / API
--------
Preload 暴露的 `window.api`（渲染进程类型声明在 `src/renderer/src/env.d.ts` 与 `src/preload/index.d.ts`）：

- window.api.quitApp(): void
- window.api.fish.findAll(): Promise<Fish[]>
- window.api.fish.findById(id): Promise<Fish | null>
- window.api.fish.search(query): Promise<Fish[]>
- window.api.fish.create(data): Promise<Fish>
- window.api.fish.update(id, data): Promise<Fish>
- window.api.fish.delete(id): Promise<void>
- window.api.fish.deleteMany(ids): Promise<void>

验收标准
------
- AC1: 渲染进程能创建/编辑/删除 Fish 并保存 ip/port。
- AC2: 对于配置了 ip/port 的 Fish，TCP 监听能接收 SENDIM 式消息并在 ID 格式下回复 ACK。
- AC3: 解析出的告警在 DB 中具有 `imgFile`、`lat`、`lon`、`fishId` 等结构化字段。
- AC4: 渲染进程能查询并展示告警。

修订记录
------
- 2025-11-10: 初始文档。

